---
/**
 * Domains Management Example
 *
 * Demonstrates creating a domain and displaying the required
 * DNS records for verification.
 *
 * @see https://resend.com/docs/dashboard/domains/introduction
 */

import Layout from '../layouts/Layout.astro';
import PageHeader from '../components/PageHeader.astro';
---

<Layout title="Domains">
  <PageHeader
    title="Domain Management"
    description="Create domains and view required DNS records for verification."
  />

  <div class="section">
    <h2>Your Domains</h2>
    <button id="load-domains" type="button">Load Domains</button>
    <div id="domains-list" class="domains-list"></div>
  </div>

  <div class="section">
    <h2>Create a Domain</h2>
    <form id="domain-form" class="form">
      <div class="field">
        <label for="domain-name">Domain Name</label>
        <input
          id="domain-name"
          type="text"
          placeholder="notifications.example.com"
          required
        />
        <span class="hint">Use a subdomain to separate transactional from marketing email</span>
      </div>
      <button type="submit" id="create-btn">Create Domain</button>
    </form>
    <div id="create-result" class="result" style="display: none;"></div>
  </div>

  <div class="dns-guide">
    <h3>DNS Record Types</h3>
    <dl>
      <dt>MX Record</dt>
      <dd>Required for receiving emails (inbound feature)</dd>
      <dt>SPF (TXT)</dt>
      <dd>Authorizes Resend to send on your domain's behalf</dd>
      <dt>DKIM (TXT)</dt>
      <dd>Cryptographic signature to prove email authenticity</dd>
      <dt>DMARC (TXT)</dt>
      <dd>Policy for handling failed authentication (recommended)</dd>
    </dl>
  </div>

  <div class="code-example">
    <h2>Code Example</h2>
    <pre><code>{`// Create a new domain
const { data: domain, error } = await resend.domains.create({
  name: 'notifications.example.com',
  region: 'us-east-1',
});

// The response includes DNS records to add
console.log(domain.records);

// Check verification status
const { data } = await resend.domains.get(domainId);
console.log(data.status); // 'pending' | 'verified' | 'failed'

// List all domains
const { data: domains } = await resend.domains.list();

// Delete a domain
await resend.domains.remove(domainId);`}</code></pre>
  </div>

  <div class="info-box">
    <h3>Best Practices</h3>
    <ul>
      <li><strong>Use subdomains:</strong> Separate transactional from marketing to protect reputation</li>
      <li><strong>Set up DMARC:</strong> Helps prevent spoofing and improves deliverability</li>
      <li><strong>Verify both SPF and DKIM:</strong> Both are important for inbox placement</li>
      <li><strong>DNS propagation:</strong> Records can take up to 48 hours to propagate</li>
    </ul>
  </div>
</Layout>

<script>
  // Load domains
  const loadBtn = document.getElementById('load-domains');
  const listDiv = document.getElementById('domains-list');

  loadBtn.addEventListener('click', async () => {
    loadBtn.disabled = true;
    loadBtn.textContent = 'Loading...';
    listDiv.innerHTML = '';

    try {
      const response = await fetch('/api/domains');
      const data = await response.json();

      if (!response.ok) {
        listDiv.innerHTML = `<p class="error-text">${data.error || 'Failed to load domains'}</p>`;
        return;
      }

      if (data.domains.length === 0) {
        listDiv.innerHTML = '<p class="empty-text">No domains found. Create one below.</p>';
        return;
      }

      const html = data.domains
        .map(
          (domain) =>
            `<div class="domain-item">
              <strong>${domain.name}</strong>
              <span class="badge badge-${domain.status}">${domain.status}</span>
            </div>`,
        )
        .join('');

      listDiv.innerHTML = html;
    } catch {
      listDiv.innerHTML = '<p class="error-text">Network error. Please try again.</p>';
    } finally {
      loadBtn.disabled = false;
      loadBtn.textContent = 'Load Domains';
    }
  });

  // Create domain
  const form = document.getElementById('domain-form');
  const createBtn = document.getElementById('create-btn');
  const resultDiv = document.getElementById('create-result');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    createBtn.disabled = true;
    createBtn.textContent = 'Creating...';
    resultDiv.style.display = 'none';

    const name = (document.getElementById('domain-name')).value;

    try {
      const response = await fetch('/api/domains', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name }),
      });

      const data = await response.json();
      resultDiv.style.display = 'block';

      if (!response.ok) {
        resultDiv.className = 'result error';
        resultDiv.textContent = data.error || 'Failed to create domain';
      } else {
        const records = data.domain.records
          .map((r) => `${r.type}: ${r.name} -> ${r.value}`)
          .join('\n');
        resultDiv.className = 'result success';
        resultDiv.innerHTML = `<strong>Domain created!</strong><br/>ID: ${data.domain.id}<br/>Status: ${data.domain.status}<br/><br/><strong>DNS Records to add:</strong><pre style="margin-top:0.5rem;background:#f0f0f0;padding:0.5rem;border-radius:0.25rem;font-size:0.75rem;color:#333;white-space:pre-wrap;">${records}</pre>`;
      }
    } catch {
      resultDiv.style.display = 'block';
      resultDiv.className = 'result error';
      resultDiv.textContent = 'Network error. Please try again.';
    } finally {
      createBtn.disabled = false;
      createBtn.textContent = 'Create Domain';
    }
  });
</script>

<style>
  .section {
    margin-bottom: 2rem;
  }

  .section h2 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  #load-domains {
    padding: 0.5rem 1rem;
    background: #1a1a1a;
    color: #fff;
    border: none;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    cursor: pointer;
    margin-bottom: 1rem;
  }

  #load-domains:hover {
    opacity: 0.9;
  }

  #load-domains:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .domains-list {
    min-height: 2rem;
  }

  .domain-item {
    padding: 0.5rem 0;
    border-bottom: 1px solid #e5e5e5;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
  }

  .badge {
    font-size: 0.75rem;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    background: #f0f0f0;
  }

  .badge-verified {
    background: #dcfce7;
    color: #166534;
  }

  .badge-pending {
    background: #fef9c3;
    color: #854d0e;
  }

  .error-text {
    color: #991b1b;
    font-size: 0.875rem;
  }

  .empty-text {
    color: #666;
    font-size: 0.875rem;
  }

  .form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .field {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .field label {
    font-size: 0.875rem;
    font-weight: 500;
  }

  .field input {
    padding: 0.5rem 0.75rem;
    border: 1px solid #e5e5e5;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    background: #fff;
  }

  .hint {
    font-size: 0.75rem;
    color: #999;
  }

  button[type='submit'] {
    padding: 0.625rem 1rem;
    background: #1a1a1a;
    color: #fff;
    border: none;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
  }

  button[type='submit']:hover {
    opacity: 0.9;
  }

  button[type='submit']:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .result {
    padding: 1rem;
    border-radius: 0.375rem;
    margin-bottom: 2rem;
    font-size: 0.875rem;
  }

  .result.success {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    color: #166534;
  }

  .result.error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #991b1b;
  }

  .dns-guide {
    margin-bottom: 2rem;
    padding: 1rem 1.25rem;
    border-radius: 0.5rem;
    background: #f0f0f0;
    border: 1px solid #e5e5e5;
  }

  .dns-guide h3 {
    font-weight: 600;
    margin-bottom: 0.75rem;
  }

  dl {
    font-size: 0.875rem;
  }

  dt {
    font-weight: 600;
    margin-top: 0.75rem;
  }

  dd {
    color: #666;
  }

  .code-example {
    margin-bottom: 2rem;
  }

  .code-example h2 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  pre {
    background: #1a1a1a;
    color: #e5e5e5;
    padding: 1rem 1.25rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    font-size: 0.8125rem;
    line-height: 1.6;
  }

  .info-box {
    padding: 1rem 1.25rem;
    border-radius: 0.5rem;
    background: #f0f0f0;
    border: 1px solid #e5e5e5;
  }

  .info-box h3 {
    font-weight: 600;
    margin-bottom: 0.75rem;
  }

  .info-box ul {
    list-style: none;
    font-size: 0.875rem;
    color: #666;
  }

  .info-box ul li {
    margin-bottom: 0.5rem;
  }
</style>
